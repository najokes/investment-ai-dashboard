<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИИ-платформа управления инвестициями МПИТ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .input-section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
        }
        
        .results-section {
            background: white;
            border-radius: 10px;
        }
        
        .section-title {
            color: #1a237e;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8eaf6;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .company-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e8eaf6;
        }
        
        .company-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .company-logo {
            width: 50px;
            height: 50px;
            background: #283593;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .company-details h3 {
            color: #1a237e;
            margin-bottom: 5px;
        }
        
        .company-details p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .inn-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .inn-input:focus {
            outline: none;
            border-color: #283593;
        }
        
        .select-company-btn {
            background: #283593;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .select-company-btn:hover {
            background: #3949ab;
        }
        
        .csv-upload-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f2ff;
            border-radius: 8px;
            border: 2px dashed #283593;
        }
        
        .csv-upload-title {
            font-size: 1rem;
            color: #283593;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .csv-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .csv-upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .csv-upload-btn:hover {
            background: #45a049;
        }
        
        .csv-download-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .csv-download-btn:hover {
            background: #0b7dda;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        label {
            font-weight: 500;
            color: #333;
            flex: 1;
            font-size: 0.95rem;
        }
        
        input, select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 140px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        input.editable, select.editable {
            background-color: white;
            color: #333;
            cursor: text;
            border-color: #ddd;
        }
        
        input.editable:focus, select.editable:focus {
            outline: none;
            border-color: #283593;
            box-shadow: 0 0 0 2px rgba(40, 53, 147, 0.1);
        }
        
        input[type="number"] {
            text-align: right;
            padding-right: 25px;
        }
        
        .input-container {
            position: relative;
            display: inline-block;
        }
        
        .suffix {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
            font-size: 0.9rem;
        }
        
        .suffix.editable {
            color: #333;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 53, 147, 0.3);
        }
        
        .calculate-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .recalculate-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .recalculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-btn {
            background: #f0f2ff;
            border: 2px solid #283593;
            color: #283593;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:hover {
            background: #283593;
            color: white;
        }
        
        .export-btn:disabled {
            background: #f5f5f5;
            border-color: #ccc;
            color: #999;
            cursor: not-allowed;
        }
        
        .results-container {
            padding: 25px;
        }
        
        .metric-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #283593;
        }
        
        .metric-subtitle {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }
        
        .algorithm-results {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .algorithm-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .algorithm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .algorithm-name {
            font-weight: 600;
            color: #1a237e;
        }
        
        .algorithm-accuracy {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        
        .algorithm-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .kpi-section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 25px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .kpi-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .kpi-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #283593;
        }
        
        .kpi-change {
            font-size: 0.9rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .positive {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .negative {
            background: #ffebee;
            color: #c62828;
        }
        
        .neutral {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .recommendations {
            margin-top: 30px;
        }
        
        .recommendation-card {
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .rec-title {
            font-weight: 600;
            color: #1a237e;
        }
        
        .rec-impact {
            background: white;
            color: #2e7d32;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        
        .rec-details {
            color: #555;
            font-size: 0.95rem;
        }
        
        .risk-indicator {
            display: inline-block;
            margin-top: 10px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .low-risk {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .medium-risk {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .high-risk {
            background: #ffebee;
            color: #c62828;
        }
        
        .ai-maturity {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
        }
        
        .maturity-score {
            font-size: 3rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .maturity-level {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .maturity-scale {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .required-mark {
            color: #e53935;
            margin-left: 2px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .success {
            background: #2e7d32;
            color: white;
        }
        
        .error {
            background: #c62828;
            color: white;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .editable-note {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .empty-field {
            color: #999 !important;
        }
        
        .csv-data-preview {
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .csv-preview-title {
            font-size: 0.9rem;
            color: #283593;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .csv-preview-table th {
            background: #f0f2ff;
            color: #283593;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .csv-preview-table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
        }
        
        .storage-indicator {
            font-size: 0.85rem;
            color: #4CAF50;
            margin-top: 10px;
            padding: 8px;
            background: #f1f8e9;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ИИ-платформа управления инвестициями</h1>
            <p class="subtitle">Трёхконтурная архитектура для data-driven решений</p>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <div class="company-selector">
                    <h2 class="section-title">Выбор компании</h2>
                    <div class="company-info">
                        <div class="company-logo">?</div>
                        <div class="company-details">
                            <h3 id="companyName">Компания не выбрана</h3>
                            <p id="companyDetails">Введите ИНН для загрузки данных или загрузите CSV-файл</p>
                        </div>
                    </div>
                    <input type="text" class="inn-input" id="companyINN" placeholder="Введите ИНН компании">
                    <button class="select-company-btn" onclick="selectCompany()">Загрузить данные компании</button>
                    
                    <div id="storageIndicator" class="storage-indicator hidden">
                        ✓ Данные из CSV успешно сохранены в хранилище
                    </div>
                    
                    <div class="csv-upload-section">
                        <div class="csv-upload-title">Загрузка данных из CSV-файла</div>
                        <input type="file" class="csv-input" id="csvFile" accept=".csv, .txt">
                        <button class="csv-upload-btn" onclick="uploadCSV()">Загрузить CSV файл</button>
                        <button class="csv-download-btn" onclick="downloadTemplateCSV()">Скачать шаблон CSV</button>
                        <div class="csv-data-preview hidden" id="csvPreview">
                            <div class="csv-preview-title">Предпросмотр данных из CSV:</div>
                            <table class="csv-preview-table" id="csvPreviewTable">
                                <thead>
                                    <tr>
                                        <th>Параметр</th>
                                        <th>Значение</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <h2 class="section-title">Параметры для анализа</h2>
                <p class="editable-note">Все поля можно редактировать перед расчетом</p>
                
                <div class="input-group">
                    <h3 style="color: #1a237e; margin-bottom: 15px; font-size: 1.1rem;">Базовые показатели</h3>
                    <div class="input-row">
                        <label>Объём инвестиций (₽)<span class="required-mark">*</span>:</label>
                        <div class="input-container">
                            <input type="text" id="investmentAmount" placeholder="—" readonly>
                            <span class="suffix">₽</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Срок инвестиций (мес.)<span class="required-mark">*</span>:</label>
                        <div class="input-container">
                            <input type="number" id="investmentPeriod" min="3" max="60" placeholder="—" readonly>
                            <span class="suffix">мес.</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Исторический ROI (%):</label>
                        <div class="input-container">
                            <input type="number" id="historicalRoi" min="5" max="50" step="0.5" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Допустимый риск<span class="required-mark">*</span>:</label>
                        <div class="input-container">
                            <input type="number" id="riskTolerance" min="1" max="30" step="0.5" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <h3 style="color: #1a237e; margin-bottom: 15px; font-size: 1.1rem;">R&D проекты</h3>
                    <div class="input-row">
                        <label>Бюджет R&D (% от инвест.)<span class="required-mark">*</span>:</label>
                        <div class="input-container">
                            <input type="number" id="rdBudget" min="5" max="40" step="1" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Кол-во активных R&D проектов:</label>
                        <div class="input-container">
                            <input type="number" id="projectCount" min="1" max="100" placeholder="—" readonly>
                            <span class="suffix">шт.</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Текущая доля окупающихся проектов:</label>
                        <div class="input-container">
                            <input type="number" id="currentRdSuccess" min="10" max="100" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Средний срок окупаемости:</label>
                        <div class="input-container">
                            <input type="number" id="currentPaybackPeriod" min="6" max="60" placeholder="—" readonly>
                            <span class="suffix">мес.</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <h3 style="color: #1a237e; margin-bottom: 15px; font-size: 1.1rem;">Клиентская база</h3>
                    <div class="input-row">
                        <label>Кол-во корпоративных клиентов:</label>
                        <div class="input-container">
                            <input type="text" id="customerCount" placeholder="—" readonly>
                            <span class="suffix">компаний</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Текущий отток клиентов (Churn Rate):</label>
                        <div class="input-container">
                            <input type="number" id="currentChurn" min="1" max="50" step="0.5" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Средний годовой LTV клиента:</label>
                        <div class="input-container">
                            <input type="text" id="avgLtv" placeholder="—" readonly>
                            <span class="suffix">₽</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Доля ключевых (TOP 20%) клиентов:</label>
                        <div class="input-container">
                            <input type="number" id="keyCustomersShare" min="20" max="100" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <h3 style="color: #1a237e; margin-bottom: 15px; font-size: 1.1rem;">Инфраструктура</h3>
                    <div class="input-row">
                        <label>Годовой CAPEX на инфраструктуру:</label>
                        <div class="input-container">
                            <input type="text" id="infraCapex" placeholder="—" readonly>
                            <span class="suffix">₽</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Уровень незапланированных простоев:</label>
                        <div class="input-container">
                            <input type="number" id="unplannedDowntime" min="0" max="20" step="0.5" placeholder="—" readonly>
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label>Затраты на техническую поддержку:</label>
                        <div class="input-container">
                            <input type="text" id="maintenanceCost" placeholder="—" readonly>
                            <span class="suffix">₽</span>
                        </div>
                    </div>
                </div>
                
                <button class="calculate-btn" id="calculateBtn" onclick="calculateResults()" disabled>Рассчитать показатели</button>
                <button class="recalculate-btn" id="recalculateBtn" onclick="recalculateResults()" style="display: none;">Пересчитать с новыми параметрами</button>
                
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportPDF()" disabled>PDF отчёт</button>
                    <button class="export-btn" onclick="exportExcel()" disabled>Excel данные</button>
                </div>
            </div>
            

                
                <div class="results-container hidden" id="resultsContainer">
                    <div class="metric-cards">
                        <div class="metric-card">
                            <div class="metric-title">Прогноз ROI с ИИ</div>
                            <div class="metric-value" id="roiValue">—</div>
                            <div class="metric-subtitle" id="roiSubtitle">Целевой: 22% | Без ИИ: —</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Прогноз оттока клиентов</div>
                            <div class="metric-value" id="churnValue">—</div>
                            <div class="metric-subtitle" id="churnSubtitle">Целевой: <6% | Без ИИ: —</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Эффективность R&D с ИИ</div>
                            <div class="metric-value" id="rdValue">—</div>
                            <div class="metric-subtitle" id="rdSubtitle">Проекты окупаются за — мес.</div>
                        </div>
                    </div>
                    
                    <div class="algorithm-results">
                        <h2 class="section-title">Аналитические модели ИИ</h2>
                        
                        <div class="algorithm-card">
                            <div class="algorithm-header">
                                <div class="algorithm-name">Прогнозирование LTV клиентов (LightGBM)</div>
                                <div class="algorithm-accuracy">Точность: 89%</div>
                            </div>
                            <div class="algorithm-details">
                                <div class="detail-item">
                                    <span>Сегмент "Высокопотенциальный":</span>
                                    <strong id="segmentHigh">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Прогноз роста LTV:</span>
                                    <strong id="ltvGrowth">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Рек. инвестиции в удержание:</span>
                                    <strong id="retentionInvestment">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Ожидаемый эффект на доходность:</span>
                                    <strong id="ltvEffect">—</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="algorithm-card">
                            <div class="algorithm-header">
                                <div class="algorithm-name">Оптимизация R&D портфеля (Q-learning)</div>
                                <div class="algorithm-accuracy">Точность: 85%</div>
                            </div>
                            <div class="algorithm-details">
                                <div class="detail-item">
                                    <span>Рек. перераспределение бюджета:</span>
                                    <strong id="rdRedistribution">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Проекты с окупаемостью ≤12 мес.:</span>
                                    <strong id="fastProjects">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Сокращение сроков окупаемости:</span>
                                    <strong id="timeOptimization">—</span>
                                </div>
                                <div class="detail-item">
                                    <span>Ожидаемый прирост выручки:</span>
                                    <strong id="revenueGrowth">—</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="algorithm-card">
                            <div class="algorithm-header">
                                <div class="algorithm-name">Предиктивное обслуживание (Автокодировщики)</div>
                                <div class="algorithm-accuracy">Точность: 94%</div>
                            </div>
                            <div class="algorithm-details">
                                <div class="detail-item">
                                    <span>Снижение незапланированных простоев:</span>
                                    <strong id="downtimeReduction">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Экономия CAPEX:</span>
                                    <strong id="capexSavings">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Снижение затрат на поддержку:</span>
                                    <strong id="maintenanceSavings">—</strong>
                                </div>
                                <div class="detail-item">
                                    <span>ROI предиктивного обслуживания:</span>
                                    <strong id="predictiveRoi">—</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="kpi-section">
                        <h2 class="section-title">Система сбалансированных KPI (после внедрения ИИ)</h2>
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-header">
                                    <span>Рентабельность инвестиционного портфеля</span>
                                    <span class="kpi-change neutral" id="roiChange">—</span>
                                </div>
                                <div class="kpi-value" id="portfolioRoi">—</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="portfolioBefore">До внедрения: —</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-header">
                                    <span>Доля неэффективных инвестиций</span>
                                    <span class="kpi-change neutral" id="ineffectiveChange">—</span>
                                </div>
                                <div class="kpi-value" id="ineffectiveInvestments">—</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="ineffectiveBefore">До внедрения: —</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-header">
                                    <span>Срок окупаемости R&D проектов</span>
                                    <span class="kpi-change neutral" id="paybackChange">—</span>
                                </div>
                                <div class="kpi-value" id="paybackPeriod">—</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="paybackBefore">До внедрения: —</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-header">
                                    <span>Время принятия инвестиционных решений</span>
                                    <span class="kpi-change neutral" id="decisionTimeChange">—</span>
                                </div>
                                <div class="kpi-value" id="decisionTime">—</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;" id="decisionBefore">До внедрения: —</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recommendations">
                        <h2 class="section-title">Рекомендации системы</h2>
                        <div id="recommendationsPlaceholder" class="loading" style="padding: 20px;">
                            <p>Загрузите данные компании и нажмите "Рассчитать показатели" для получения рекомендаций</p>
                        </div>
                        <div id="recommendationsContent" class="hidden">
                            <!-- Рекомендации будут здесь -->
                        </div>
                    </div>
                    
                    <div class="ai-maturity">
                        <h3>Индекс "ИИ-зрелости" управленческой команды</h3>
                        <div class="maturity-score" id="aiMaturityScore">—</div>
                        <div class="maturity-level" id="maturityLevel">Не определен</div>
                        <div class="maturity-scale">Оценка по шкале от 1 до 5</div>
                        <p style="margin-top: 10px; opacity: 0.9; font-size: 0.9rem;">
                            Оценка основана на использовании data-driven подходов, понимании ИИ-инструментов и скорости принятия решений после внедрения трёхконтурной модели
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Хранилище данных - симуляция базы данных в браузере
        const dataStorage = {
            // Начальные данные для компаний
            '5047154189': {
                name: 'ООО "Мобайл Парк ИТ"',
                type: 'Технологическая компания B2B',
                description: 'Разработка IT-решений и облачных сервисов (PaaS)',
                logoText: 'МП',
                data: {
                    investmentAmount: 150000000,
                    investmentPeriod: 24,
                    historicalRoi: 15,
                    riskTolerance: 10,
                    rdBudget: 25,
                    projectCount: 45,
                    currentRdSuccess: 40,
                    currentPaybackPeriod: 24,
                    customerCount: 500,
                    currentChurn: 10,
                    avgLtv: 1500000,
                    keyCustomersShare: 32,
                    infraCapex: 15000000,
                    unplannedDowntime: 5,
                    maintenanceCost: 4500000
                }
            },
            '1234567890': {
                name: 'ООО "ТехноИнвест"',
                type: 'Инвестиционная компания',
                description: 'Управление венчурными инвестициями',
                logoText: 'ТИ',
                data: {
                    investmentAmount: 80000000,
                    investmentPeriod: 36,
                    historicalRoi: 18,
                    riskTolerance: 15,
                    rdBudget: 30,
                    projectCount: 25,
                    currentRdSuccess: 35,
                    currentPaybackPeriod: 30,
                    customerCount: 150,
                    currentChurn: 8,
                    avgLtv: 2500000,
                    keyCustomersShare: 40,
                    infraCapex: 8000000,
                    unplannedDowntime: 3,
                    maintenanceCost: 2400000
                }
            },
            'test': {
                name: 'Тестовая компания',
                type: 'Технологический стартап',
                description: 'Разработка инновационных решений',
                logoText: 'ТЕ',
                data: {
                    investmentAmount: 50000000,
                    investmentPeriod: 18,
                    historicalRoi: 12,
                    riskTolerance: 8,
                    rdBudget: 20,
                    projectCount: 15,
                    currentRdSuccess: 30,
                    currentPaybackPeriod: 30,
                    customerCount: 80,
                    currentChurn: 15,
                    avgLtv: 800000,
                    keyCustomersShare: 25,
                    infraCapex: 5000000,
                    unplannedDowntime: 8,
                    maintenanceCost: 2000000
                }
            }
        };
        
        // Переменная для отслеживания состояния
        let isCalculated = false;
        let currentCompany = null;
        let previousValues = {};
        let uploadedCompanyData = null;
        let storageUpdated = false;
        
        // Сбросить все поля до пустых значений
        function resetFormFields() {
            const inputs = document.querySelectorAll('.input-section input:not(#companyINN):not(#csvFile)');
            inputs.forEach(input => {
                input.value = '';
                input.setAttribute('readonly', true);
                input.classList.remove('editable');
                input.classList.add('empty-field');
            });
            
            // Сбросить суффиксы
            const suffixes = document.querySelectorAll('.suffix');
            suffixes.forEach(suffix => {
                suffix.classList.remove('editable');
            });
            
            // Деактивировать кнопки
            document.getElementById('calculateBtn').disabled = true;
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.disabled = true;
            });
        }
        
        // Включить все поля формы
        function enableFormFields() {
            const inputs = document.querySelectorAll('.input-section input:not(#companyINN):not(#csvFile)');
            inputs.forEach(input => {
                input.removeAttribute('readonly');
                input.classList.add('editable');
                input.classList.remove('empty-field');
            });
            
            // Активировать суффиксы
            const suffixes = document.querySelectorAll('.suffix');
            suffixes.forEach(suffix => {
                suffix.classList.add('editable');
            });
            
            document.getElementById('calculateBtn').disabled = false;
            document.getElementById('calculateBtn').textContent = 'Рассчитать показатели';
            
            // Активируем кнопки экспорта
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.disabled = false;
            });
        }
        
        // Форматирование чисел с разделителями тысяч при вводе
        function formatNumberOnBlur(input) {
            if (!input.value) return;
            
            let value = input.value.replace(/\s/g, '').replace(/,/g, '');
            
            if (!isNaN(value) && value !== '' && value !== '—') {
                let num = parseInt(value);
                input.setAttribute('data-original', num);
                
                let formatted = num.toLocaleString('ru-RU');
                input.value = formatted;
            }
        }
        
        // Очистка форматирования при фокусе
        function clearFormatting(input) {
            let original = input.getAttribute('data-original');
            if (original) {
                input.value = original;
            } else if (input.value === '—' || input.value === '') {
                input.value = '';
            }
        }
        
        // Получение числового значения из форматированного поля
        function getNumericValue(inputId) {
            const input = document.getElementById(inputId);
            if (!input.value || input.value === '—') return 0;
            
            let value = input.value.replace(/\s/g, '').replace(/,/g, '');
            return parseInt(value) || 0;
        }
        
        // Получение значения с плавающей точкой
        function getFloatValue(inputId) {
            const input = document.getElementById(inputId);
            if (!input.value || input.value === '—') return 0;
            
            let value = input.value.replace(/\s/g, '').replace(/,/g, '');
            return parseFloat(value) || 0;
        }
        
        // Выбор компании по ИНН
        function selectCompany() {
            const inn = document.getElementById('companyINN').value.trim();
            
            if (!inn) {
                showNotification('Введите ИНН компании', 'error');
                return;
            }
            
            // Проверяем есть ли компания в хранилище (включая загруженные из CSV данные)
            if (dataStorage[inn] || inn === 'test') {
                currentCompany = dataStorage[inn] || dataStorage['test'];
                uploadedCompanyData = null;
                
                // Обновляем информацию о компании
                document.getElementById('companyName').textContent = currentCompany.name;
                document.getElementById('companyDetails').textContent = currentCompany.type + ' | ' + currentCompany.description;
                document.querySelector('.company-logo').textContent = currentCompany.logoText;
                document.querySelector('.company-logo').style.backgroundColor = '#283593';
                
                // Особое сообщение если это Мобайл Парк ИТ
                if (inn === '5047154189' && storageUpdated) {
                    document.getElementById('companyDetails').textContent = '✓ Данные обновлены из CSV файла | ' + currentCompany.description;
                    showNotification('Используются данные из CSV файла для Мобайл Парк ИТ', 'success');
                }
                
                // Сохраняем предыдущие значения для сравнения
                saveCurrentValues();
                
                // Заполняем данные компании из хранилища
                fillCompanyData(currentCompany);
                
                // Включаем поля формы
                enableFormFields();
                
                // Скрываем кнопку пересчета если она была показана
                document.getElementById('recalculateBtn').style.display = 'none';
                document.getElementById('calculateBtn').style.display = 'block';
                
                // Сбрасываем состояние расчета
                isCalculated = false;
                
                // Скрываем результаты если они были показаны
                document.getElementById('resultsContainer').classList.add('hidden');
                document.getElementById('loadingIndicator').classList.remove('hidden');
                
                // Скрываем предпросмотр CSV
                document.getElementById('csvPreview').classList.add('hidden');
                
            } else {
                showNotification('Компания с таким ИНН не найдена в базе', 'error');
                document.getElementById('companyName').textContent = 'Компания не найдена';
                document.getElementById('companyDetails').textContent = 'Проверьте правильность ИНН';
                document.querySelector('.company-logo').textContent = '!';
                document.querySelector('.company-logo').style.backgroundColor = '#c62828';
                currentCompany = null;
                uploadedCompanyData = null;
                
                // Сбрасываем поля формы
                resetFormFields();
            }
        }
        
        // Сохранить текущие значения для сравнения
        function saveCurrentValues() {
            previousValues = {
                investmentAmount: getNumericValue('investmentAmount'),
                investmentPeriod: getFloatValue('investmentPeriod'),
                historicalRoi: getFloatValue('historicalRoi'),
                riskTolerance: getFloatValue('riskTolerance'),
                rdBudget: getFloatValue('rdBudget'),
                projectCount: getFloatValue('projectCount'),
                currentRdSuccess: getFloatValue('currentRdSuccess'),
                currentPaybackPeriod: getFloatValue('currentPaybackPeriod'),
                customerCount: getNumericValue('customerCount'),
                currentChurn: getFloatValue('currentChurn'),
                avgLtv: getNumericValue('avgLtv'),
                keyCustomersShare: getFloatValue('keyCustomersShare'),
                infraCapex: getNumericValue('infraCapex'),
                unplannedDowntime: getFloatValue('unplannedDowntime'),
                maintenanceCost: getNumericValue('maintenanceCost')
            };
        }
        
        // Заполнение данных компании
        function fillCompanyData(company) {
            const data = company.data || company;
            
            // Заполняем поля с форматированием
            document.getElementById('investmentAmount').value = data.investmentAmount.toLocaleString('ru-RU');
            document.getElementById('investmentAmount').setAttribute('data-original', data.investmentAmount);
            
            document.getElementById('investmentPeriod').value = data.investmentPeriod;
            document.getElementById('historicalRoi').value = data.historicalRoi;
            document.getElementById('riskTolerance').value = data.riskTolerance;
            document.getElementById('rdBudget').value = data.rdBudget;
            document.getElementById('projectCount').value = data.projectCount;
            document.getElementById('currentRdSuccess').value = data.currentRdSuccess;
            document.getElementById('currentPaybackPeriod').value = data.currentPaybackPeriod;
            
            document.getElementById('customerCount').value = data.customerCount.toLocaleString('ru-RU');
            document.getElementById('customerCount').setAttribute('data-original', data.customerCount);
            
            document.getElementById('currentChurn').value = data.currentChurn;
            document.getElementById('avgLtv').value = data.avgLtv.toLocaleString('ru-RU');
            document.getElementById('avgLtv').setAttribute('data-original', data.avgLtv);
            
            document.getElementById('keyCustomersShare').value = data.keyCustomersShare;
            document.getElementById('infraCapex').value = data.infraCapex.toLocaleString('ru-RU');
            document.getElementById('infraCapex').setAttribute('data-original', data.infraCapex);
            
            document.getElementById('unplannedDowntime').value = data.unplannedDowntime;
            document.getElementById('maintenanceCost').value = data.maintenanceCost.toLocaleString('ru-RU');
            document.getElementById('maintenanceCost').setAttribute('data-original', data.maintenanceCost);
            
            // Сохраняем новые значения
            saveCurrentValues();
            
            // Добавляем обработчики для форматирования
            const numberInputs = document.querySelectorAll('input[type="text"]:not(#companyINN)');
            numberInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    formatNumberOnBlur(this);
                });
                input.addEventListener('focus', function() {
                    clearFormatting(this);
                });
            });
        }
        
        // Загрузка CSV файла
        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Выберите CSV файл для загрузки', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const csvData = parseCSV(csvContent);
                    
                    if (csvData) {
                        // Имитация загрузки данных в хранилище
                        simulateDataStorage(csvData);
                        
                        // Показываем предпросмотр данных
                        showCSVPreview(csvData);
                        
                        showNotification('CSV файл успешно загружен. Данные сохранены в хранилище.', 'success');
                    }
                } catch (error) {
                    console.error('Ошибка обработки CSV:', error);
                    showNotification('Ошибка обработки CSV файла. Проверьте формат.', 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Ошибка чтения файла', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // Имитация сохранения данных в хранилище
        function simulateDataStorage(csvData) {
            // Показываем индикатор хранения
            document.getElementById('storageIndicator').classList.remove('hidden');
            
            // Устанавливаем флаг обновления хранилища
            storageUpdated = true;
            
            // Обновляем хранилище данных
            // Для тестирования обновляем данные Мобайл Парк ИТ
            if (dataStorage['5047154189']) {
                // Обновляем данные для Мобайл Парк ИТ из CSV
                Object.assign(dataStorage['5047154189'].data, csvData);
                
                // Обновляем название если оно есть в CSV
                if (csvData.name) {
                    dataStorage['5047154189'].name = csvData.name;
                }
                
                // Показываем сообщение о том, что данные обновлены
                showNotification('Данные для Мобайл Парк ИТ обновлены из CSV файла', 'success');
            }
            
            // Также создаем отдельную запись для загруженных данных
            const csvCompanyId = 'csv_' + Date.now();
            dataStorage[csvCompanyId] = {
                name: csvData.name || 'Загруженная из CSV компания',
                type: csvData.type || 'Данные из CSV файла',
                description: 'Данные загружены из CSV файла',
                logoText: 'CSV',
                data: csvData
            };
            
            // Через 5 секунд скрываем индикатор
            setTimeout(() => {
                document.getElementById('storageIndicator').classList.add('hidden');
            }, 5000);
        }
        
        // Парсинг CSV файла
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const data = {};
            
            // Определяем разделитель (запятая или точка с запятой)
            const delimiter = csvContent.includes(';') ? ';' : ',';
            
            lines.forEach(line => {
                line = line.trim();
                if (line && !line.startsWith('#')) {
                    const parts = line.split(delimiter);
                    if (parts.length >= 2) {
                        const key = parts[0].trim().replace(/"/g, '');
                        let value = parts[1].trim().replace(/"/g, '');
                        
                        // Преобразование числовых значений
                        if (!isNaN(value) && value !== '') {
                            if (value.includes('.')) {
                                value = parseFloat(value);
                            } else {
                                value = parseInt(value);
                            }
                        }
                        
                        data[key] = value;
                    }
                }
            });
            
            // Проверяем, что есть основные поля
            const requiredFields = ['investmentAmount', 'investmentPeriod'];
            const missingFields = requiredFields.filter(field => !data[field]);
            
            if (missingFields.length > 0) {
                showNotification(`В CSV отсутствуют обязательные поля: ${missingFields.join(', ')}`, 'error');
                return null;
            }
            
            // Форматируем данные для отображения
            data.name = data.name || 'Загруженная из CSV компания';
            data.type = data.type || 'Данные из CSV файла';
            
            return data;
        }
        
        // Показать предпросмотр CSV данных
        function showCSVPreview(data) {
            const previewTable = document.getElementById('csvPreviewTable').getElementsByTagName('tbody')[0];
            previewTable.innerHTML = '';
            
            const fields = [
                {key: 'investmentAmount', label: 'Объём инвестиций (₽)'},
                {key: 'investmentPeriod', label: 'Срок инвестиций (мес.)'},
                {key: 'historicalRoi', label: 'Исторический ROI (%)'},
                {key: 'riskTolerance', label: 'Допустимый риск (%)'},
                {key: 'rdBudget', label: 'Бюджет R&D (%)'},
                {key: 'projectCount', label: 'Кол-во R&D проектов'},
                {key: 'currentRdSuccess', label: 'Доля окупающихся проектов (%)'},
                {key: 'currentPaybackPeriod', label: 'Срок окупаемости (мес.)'},
                {key: 'customerCount', label: 'Кол-во клиентов'},
                {key: 'currentChurn', label: 'Отток клиентов (%)'},
                {key: 'avgLtv', label: 'Средний LTV (₽)'},
                {key: 'keyCustomersShare', label: 'Доля ключевых клиентов (%)'},
                {key: 'infraCapex', label: 'CAPEX на инфраструктуру (₽)'},
                {key: 'unplannedDowntime', label: 'Незапланированные простои (%)'},
                {key: 'maintenanceCost', label: 'Затраты на поддержку (₽)'}
            ];
            
            fields.forEach(field => {
                if (data[field.key] !== undefined) {
                    const row = previewTable.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = field.label;
                    
                    // Форматируем значение
                    let value = data[field.key];
                    if (typeof value === 'number') {
                        if (field.key.includes('Amount') || field.key.includes('Cost') || field.key.includes('Capex') || field.key.includes('Ltv')) {
                            value = value.toLocaleString('ru-RU') + ' ₽';
                        } else if (field.key.includes('Roi') || field.key.includes('Tolerance') || field.key.includes('Budget') || 
                                  field.key.includes('Success') || field.key.includes('Churn') || field.key.includes('Share') || 
                                  field.key.includes('Downtime')) {
                            value = value + ' %';
                        } else if (field.key.includes('Period')) {
                            value = value + ' мес.';
                        } else if (field.key.includes('Count')) {
                            value = value + ' шт.';
                        }
                    }
                    
                    cell2.textContent = value;
                }
            });
            
            document.getElementById('csvPreview').classList.remove('hidden');
        }
        
        // Скачать шаблон CSV файла
        function downloadTemplateCSV() {
            // Данные для шаблона CSV
            const csvData = [
                ['# Шаблон CSV файла для загрузки данных компании', ''],
                ['# Все значения должны быть указаны без кавычек', ''],
                ['name', 'ООО "Мобайл Парк ИТ"'],
                ['type', 'Технологическая компания B2B'],
                ['investmentAmount', '150000000'],
                ['investmentPeriod', '24'],
                ['historicalRoi', '15'],
                ['riskTolerance', '10'],
                ['rdBudget', '25'],
                ['projectCount', '45'],
                ['currentRdSuccess', '40'],
                ['currentPaybackPeriod', '24'],
                ['customerCount', '500'],
                ['currentChurn', '10'],
                ['avgLtv', '1500000'],
                ['keyCustomersShare', '32'],
                ['infraCapex', '15000000'],
                ['unplannedDowntime', '5'],
                ['maintenanceCost', '4500000'],
                ['# Конец файла', '']
            ];
            
            // Преобразуем в CSV строку
            const csvContent = csvData.map(row => row.join(';')).join('\n');
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'mobile_park_it_template.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Шаблон CSV файла успешно скачан', 'success');
        }
        
        // Расчет результатов
        function calculateResults() {
            // Проверяем, что данные загружены
            if (!currentCompany && !uploadedCompanyData) {
                showNotification('Сначала загрузите данные компании по ИНН или из CSV', 'error');
                return;
            }
            
            // Проверяем, что обязательные поля заполнены
            const investmentAmount = getNumericValue('investmentAmount');
            const investmentPeriod = getFloatValue('investmentPeriod');
            const riskTolerance = getFloatValue('riskTolerance');
            const rdBudget = getFloatValue('rdBudget');
            
            if (investmentAmount === 0 || investmentPeriod === 0 || riskTolerance === 0 || rdBudget === 0) {
                showNotification('Заполните все обязательные поля (отмечены *)', 'error');
                return;
            }
            
            // Показать результаты
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');
            document.getElementById('recommendationsPlaceholder').classList.add('hidden');
            document.getElementById('recommendationsContent').classList.remove('hidden');
            
            // Показать кнопку пересчета
            document.getElementById('recalculateBtn').style.display = 'block';
            document.getElementById('calculateBtn').style.display = 'none';
            
            // Устанавливаем флаг расчета
            isCalculated = true;
            
            // Выполняем расчет
            performCalculation();
        }
        
        // Пересчет результатов
        function recalculateResults() {
            if (!currentCompany && !uploadedCompanyData) {
                showNotification('Сначала загрузите данные компании', 'error');
                return;
            }
            
            // Сохраняем текущие значения
            saveCurrentValues();
            
            // Выполняем расчет
            performCalculation();
            
            showNotification('Показатели пересчитаны с новыми параметрами', 'success');
        }
        
        // Основная функция расчета
        function performCalculation() {
            // Получение ТЕКУЩИХ значений из формы
            const investmentAmount = getNumericValue('investmentAmount');
            const investmentPeriod = getFloatValue('investmentPeriod');
            const historicalRoi = getFloatValue('historicalRoi');
            const riskTolerance = getFloatValue('riskTolerance');
            const rdBudget = getFloatValue('rdBudget');
            const projectCount = getFloatValue('projectCount');
            const currentRdSuccess = getFloatValue('currentRdSuccess');
            const currentPaybackPeriod = getFloatValue('currentPaybackPeriod');
            const customerCount = getNumericValue('customerCount');
            const currentChurn = getFloatValue('currentChurn');
            const avgLtv = getNumericValue('avgLtv');
            const keyCustomersShare = getFloatValue('keyCustomersShare');
            const infraCapex = getNumericValue('infraCapex');
            const unplannedDowntime = getFloatValue('unplannedDowntime');
            const maintenanceCost = getNumericValue('maintenanceCost');
            
            // Расчет показателей на основе ВВЕДЕННЫХ данных
            const results = calculateIndicators({
                investmentAmount,
                investmentPeriod,
                historicalRoi,
                riskTolerance,
                rdBudget,
                projectCount,
                currentRdSuccess,
                currentPaybackPeriod,
                customerCount,
                currentChurn,
                avgLtv,
                keyCustomersShare,
                infraCapex,
                unplannedDowntime,
                maintenanceCost
            });
            
            // Определяем имя компании для рекомендаций
            const companyName = currentCompany ? currentCompany.name : 
                               (uploadedCompanyData && uploadedCompanyData.name) ? uploadedCompanyData.name : 'Компания';
            
            // Обновление UI с результатами
            updateResultsUI(results, {
                investmentAmount,
                investmentPeriod,
                historicalRoi,
                riskTolerance,
                rdBudget,
                projectCount,
                currentRdSuccess,
                currentPaybackPeriod,
                customerCount,
                currentChurn,
                avgLtv,
                keyCustomersShare,
                infraCapex,
                unplannedDowntime,
                maintenanceCost
            });
            
            // Генерация рекомендаций
            generateRecommendations(results, companyName);
        }
        
        // Расчет индикаторов на основе входных данных
        function calculateIndicators(inputs) {
            // Базовые коэффициенты из ВКР с динамической адаптацией
            
            // Динамический расчет ROI на основе введенных данных
            let baseRoi = inputs.historicalRoi || 15;
            let roiWithAI = baseRoi * 1.4; // Базовое улучшение 40%
            
            // Корректировка ROI на основе объема инвестиций
            if (inputs.investmentAmount > 200000000) {
                roiWithAI *= 1.1; // +10% для больших инвестиций
            } else if (inputs.investmentAmount < 50000000) {
                roiWithAI *= 0.95; // -5% для малых инвестиций
            }
            
            // Корректировка на основе риск-аппетита
            if (inputs.riskTolerance > 15) {
                roiWithAI *= 1.07; // +7% для высокого риска
            } else if (inputs.riskTolerance < 5) {
                roiWithAI *= 0.93; // -7% для низкого риска
            }
            
            // Динамический расчет оттока клиентов
            let baseChurn = inputs.currentChurn || 10;
            let churnWithAI = baseChurn * 0.7; // Снижение на 30%
            
            // Корректировка оттока на основе LTV
            if (inputs.avgLtv > 2000000) {
                churnWithAI *= 0.9; // Дополнительное снижение для высокого LTV
            }
            
            // Динамический расчет эффективности R&D
            let baseRdEfficiency = inputs.currentRdSuccess || 40;
            let rdEfficiency = baseRdEfficiency * 1.625; // Улучшение на 62.5%
            
            // Корректировка на основе бюджета R&D
            if (inputs.rdBudget > 30) {
                rdEfficiency *= 1.08; // +8% для большого бюджета
            } else if (inputs.rdBudget < 15) {
                rdEfficiency *= 0.92; // -8% для малого бюджета
            }
            
            // Динамический расчет срока окупаемости
            let basePayback = inputs.currentPaybackPeriod || 24;
            let paybackPeriod = basePayback * 0.792; // Ускорение на 20.8%
            
            // Динамический расчет для LightGBM модели
            let segmentHigh = Math.min(50, Math.max(20, inputs.keyCustomersShare || 32));
            let ltvGrowth = Math.min(15, Math.max(5, 8 * (inputs.avgLtv / 1500000))); // Зависит от LTV
            let retentionInvestment = Math.min(40, Math.max(15, 25 * (inputs.currentChurn / 10))); // Зависит от оттока
            let ltvEffect = Math.min(25, Math.max(10, 15 * (inputs.avgLtv / 1500000))); // Зависит от LTV
            
            // Динамический расчет для Q-learning модели
            let rdRedistribution = Math.min(30, Math.max(10, 20 * (inputs.rdBudget / 25))); // Зависит от бюджета
            let fastProjects = Math.min(80, Math.max(40, 65 * (inputs.projectCount / 45))); // Зависит от кол-ва проектов
            let timeOptimization = Math.min(8, Math.max(2, 5 * (inputs.currentPaybackPeriod / 24))); // Зависит от срока окупаемости
            let revenueGrowth = Math.min(25, Math.max(10, 15 * (inputs.currentRdSuccess / 40))); // Зависит от эффективности
            
            // Динамический расчет для предиктивного обслуживания
            let downtimeReduction = Math.min(60, Math.max(20, 40 * (inputs.unplannedDowntime / 5))); // Зависит от простоев
            let capexSavings = Math.min(25, Math.max(5, 15 * (inputs.infraCapex / 15000000))); // Зависит от CAPEX
            let maintenanceSavings = Math.min(25, Math.max(10, 18 * (inputs.maintenanceCost / 4500000))); // Зависит от затрат на поддержку
            let predictiveRoi = Math.min(350, Math.max(150, 245 * (inputs.infraCapex / 15000000))); // Зависит от CAPEX
            
            // Расчет индекса ИИ-зрелости на основе всех параметров
            let maturityScore = calculateMaturityScore(inputs);
            let maturityLevel = getMaturityLevel(maturityScore);
            
            return {
                roiWithAI: Math.min(35, Math.max(10, roiWithAI)),
                churnWithAI: Math.min(20, Math.max(2, churnWithAI)),
                rdEfficiency: Math.min(85, Math.max(30, rdEfficiency)),
                paybackPeriod: Math.min(36, Math.max(12, paybackPeriod)),
                segmentHigh: Math.round(segmentHigh),
                ltvGrowth: Math.round(ltvGrowth),
                retentionInvestment: Math.round(retentionInvestment),
                ltvEffect: Math.round(ltvEffect),
                rdRedistribution: Math.round(rdRedistribution),
                fastProjects: Math.round(fastProjects),
                timeOptimization: Math.round(timeOptimization),
                revenueGrowth: Math.round(revenueGrowth),
                downtimeReduction: Math.round(downtimeReduction),
                capexSavings: Math.round(capexSavings),
                maintenanceSavings: Math.round(maintenanceSavings),
                predictiveRoi: Math.round(predictiveRoi),
                ineffectiveInvestments: Math.max(5, Math.min(30, 25 - (inputs.historicalRoi / 2))), // Зависит от ROI
                decisionTime: Math.max(5, Math.min(20, 28 - (inputs.investmentAmount / 10000000))), // Зависит от объема инвестиций
                maturityScore: maturityScore,
                maturityLevel: maturityLevel
            };
        }
        
        // Расчет индекса ИИ-зрелости
        function calculateMaturityScore(inputs) {
            let score = 3.0; // Базовый уровень
            
            // Корректировка на основе объема инвестиций
            if (inputs.investmentAmount > 100000000) score += 0.5;
            else if (inputs.investmentAmount < 30000000) score -= 0.3;
            
            // Корректировка на основе ROI
            if (inputs.historicalRoi > 20) score += 0.4;
            else if (inputs.historicalRoi < 10) score -= 0.2;
            
            // Корректировка на основе бюджета R&D
            if (inputs.rdBudget > 25) score += 0.3;
            else if (inputs.rdBudget < 15) score -= 0.2;
            
            // Корректировка на основе оттока клиентов
            if (inputs.currentChurn < 8) score += 0.2;
            else if (inputs.currentChurn > 15) score -= 0.3;
            
            // Ограничение значения
            return Math.min(5.0, Math.max(1.0, score)).toFixed(1);
        }
        
        // Определение уровня зрелости
        function getMaturityLevel(score) {
            if (score >= 4.5) return 'Очень высокий уровень';
            if (score >= 4.0) return 'Высокий уровень';
            if (score >= 3.5) return 'Выше среднего';
            if (score >= 3.0) return 'Средний уровень';
            if (score >= 2.5) return 'Ниже среднего';
            return 'Начальный уровень';
        }
        
        // Обновление интерфейса с результатами
        function updateResultsUI(results, currentValues) {
            // Обновление метрик
            document.getElementById('roiValue').textContent = results.roiWithAI.toFixed(1) + '%';
            document.getElementById('churnValue').textContent = results.churnWithAI.toFixed(1) + '%';
            document.getElementById('rdValue').textContent = results.rdEfficiency.toFixed(0) + '%';
            
            // Обновление подзаголовков
            document.getElementById('roiSubtitle').innerHTML = `Целевой: 22% | Без ИИ: ${currentValues.historicalRoi.toFixed(1)}%`;
            document.getElementById('churnSubtitle').innerHTML = `Целевой: <6% | Без ИИ: ${currentValues.currentChurn.toFixed(1)}%`;
            document.getElementById('rdSubtitle').innerHTML = `Проекты окупаются за ${results.paybackPeriod.toFixed(0)} мес.`;
            
            // Обновление деталей алгоритмов
            document.getElementById('segmentHigh').textContent = results.segmentHigh + '%';
            document.getElementById('ltvGrowth').textContent = '+' + results.ltvGrowth + '%';
            document.getElementById('retentionInvestment').textContent = results.retentionInvestment + '%';
            document.getElementById('ltvEffect').textContent = '+' + results.ltvEffect + '%';
            
            document.getElementById('rdRedistribution').textContent = results.rdRedistribution + '%';
            document.getElementById('fastProjects').textContent = results.fastProjects + '%';
            document.getElementById('timeOptimization').textContent = '-' + results.timeOptimization + ' месяцев';
            document.getElementById('revenueGrowth').textContent = '+' + results.revenueGrowth + '%';
            
            document.getElementById('downtimeReduction').textContent = results.downtimeReduction + '%';
            document.getElementById('capexSavings').textContent = results.capexSavings + '%';
            document.getElementById('maintenanceSavings').textContent = results.maintenanceSavings + '%';
            document.getElementById('predictiveRoi').textContent = results.predictiveRoi + '%';
            
            // Расчет изменений для KPI
            const roiChange = results.roiWithAI - currentValues.historicalRoi;
            const ineffectiveChange = (25 - results.ineffectiveInvestments);
            const paybackChange = currentValues.currentPaybackPeriod - results.paybackPeriod;
            const decisionTimeChange = 28 - results.decisionTime;
            
            // Обновление KPI
            document.getElementById('portfolioRoi').textContent = results.roiWithAI.toFixed(1) + '%';
            updateKPIChange('roiChange', roiChange, '%', true);
            document.getElementById('portfolioBefore').innerHTML = `До внедрения: ${currentValues.historicalRoi.toFixed(1)}%`;
            
            document.getElementById('ineffectiveInvestments').textContent = results.ineffectiveInvestments + '%';
            updateKPIChange('ineffectiveChange', ineffectiveChange, '%', false);
            document.getElementById('ineffectiveBefore').innerHTML = `До внедрения: 25%`;
            
            document.getElementById('paybackPeriod').textContent = results.paybackPeriod.toFixed(0) + ' мес.';
            updateKPIChange('paybackChange', paybackChange, 'мес.', true);
            document.getElementById('paybackBefore').innerHTML = `До внедрения: ${currentValues.currentPaybackPeriod} мес.`;
            
            document.getElementById('decisionTime').textContent = results.decisionTime + ' дней';
            updateKPIChange('decisionTimeChange', decisionTimeChange, 'дней', true);
            document.getElementById('decisionBefore').innerHTML = `До внедрения: 28 дней`;
            
            // Обновление ИИ-зрелости
            document.getElementById('aiMaturityScore').textContent = results.maturityScore;
            document.getElementById('maturityLevel').textContent = results.maturityLevel;
        }
        
        // Обновление KPI изменений
        function updateKPIChange(elementId, value, unit, isPositiveWhenNegative = false) {
            const element = document.getElementById(elementId);
            
            if (Math.abs(value) < 0.1) {
                element.textContent = '0 ' + unit;
                element.className = 'kpi-change neutral';
                return;
            }
            
            let formatted = value > 0 ? '+' + value.toFixed(1) : value.toFixed(1);
            formatted += ' ' + unit;
            element.textContent = formatted;
            
            // Определяем класс в зависимости от знака и типа изменения
            if ((value > 0 && !isPositiveWhenNegative) || (value < 0 && isPositiveWhenNegative)) {
                element.className = 'kpi-change positive';
            } else if ((value < 0 && !isPositiveWhenNegative) || (value > 0 && isPositiveWhenNegative)) {
                element.className = 'kpi-change negative';
            } else {
                element.className = 'kpi-change neutral';
            }
        }
        
        // Генерация рекомендаций
        function generateRecommendations(results, companyName) {
            const riskLevel = results.maturityScore >= 4 ? 'low-risk' : 
                             results.maturityScore >= 3 ? 'medium-risk' : 'high-risk';
            const riskText = results.maturityScore >= 4 ? 'Низкий риск' : 
                            results.maturityScore >= 3 ? 'Средний риск' : 'Высокий риск';
            
            const recommendationsHTML = `
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <div class="rec-title">Увеличение инвестиций в сегмент "Высокопотенциальный"</div>
                        <div class="rec-impact">+${results.ltvGrowth}% ROI</div>
                    </div>
                    <div class="rec-details">
                        На основе прогноза LTV рекомендовано увеличить инвестиции в развитие продуктов для клиентов с прогнозируемым LTV > 2 млн ₽ (${results.segmentHigh}% клиентской базы ${companyName}). Ожидаемый рост доходности сегмента: +${results.ltvEffect}%.
                    </div>
                    <div class="risk-indicator ${riskLevel}">${riskText}</div>
                </div>
                
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <div class="rec-title">Перераспределение R&D бюджета на основе алгоритма Q-learning</div>
                        <div class="rec-impact">-${results.timeOptimization} месяцев окупаемости</div>
                    </div>
                    <div class="rec-details">
                        Алгоритм рекомендует перевести ${results.rdRedistribution}% бюджета из долгосрочных проектов в проекты с быстрой коммерциализацией. Ожидается увеличение доли окупающихся проектов до ${results.fastProjects}% и сокращение среднего срока окупаемости с 24 до ${results.paybackPeriod} месяцев.
                    </div>
                    <div class="risk-indicator medium-risk">Средний риск</div>
                </div>
                
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <div class="rec-title">Внедрение предиктивного обслуживания инфраструктуры</div>
                        <div class="rec-impact">${results.downtimeReduction}% снижение простоев</div>
                    </div>
                    <div class="rec-details">
                        Система на основе автокодировщиков рекомендована для прогнозирования сбоев оборудования. Ожидаемая экономия: снижение незапланированных простоев на ${results.downtimeReduction}%, оптимизация CAPEX на ${results.capexSavings}% и снижение затрат на поддержку на ${results.maintenanceSavings}%.
                    </div>
                    <div class="risk-indicator low-risk">Низкий риск</div>
                </div>
            `;
            
            document.getElementById('recommendationsContent').innerHTML = recommendationsHTML;
        }
        
        // Экспорт PDF
        function exportPDF() {
            if (!currentCompany && !uploadedCompanyData) {
                showNotification('Сначала загрузите данные компании', 'error');
                return;
            }
            if (!isCalculated) {
                showNotification('Сначала выполните расчет показателей', 'error');
                return;
            }
            showNotification('PDF-отчёт формируется...', 'success');
        }
        
        // Экспорт Excel
        function exportExcel() {
            if (!currentCompany && !uploadedCompanyData) {
                showNotification('Сначала загрузите данные компании', 'error');
                return;
            }
            if (!isCalculated) {
                showNotification('Сначала выполните расчет показателей', 'error');
                return;
            }
            showNotification('Excel-файл с данными готов к скачиванию', 'success');
        }
        
        // Показать уведомление
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Сбрасываем поля при загрузке
            resetFormFields();
            
            // Разрешаем ввод ИНН по Enter
            document.getElementById('companyINN').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    selectCompany();
                }
            });
            
            // Автоматическое форматирование чисел при вводе
            document.addEventListener('input', function(e) {
                if (e.target.type === 'text' && e.target.id !== 'companyINN' && e.target.classList.contains('editable')) {
                    // Позволяем вводить только цифры и запятые
                    e.target.value = e.target.value.replace(/[^\d,]/g, '');
                }
            });
            
            // Валидация числовых полей
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    if (this.classList.contains('editable')) {
                        const value = parseFloat(this.value);
                        if (this.min && value < parseFloat(this.min)) {
                            this.value = this.min;
                        }
                        if (this.max && value > parseFloat(this.max)) {
                            this.value = this.max;
                        }
                    }
                });
            });
            
            // Автоматическая загрузка CSV при выборе файла
            document.getElementById('csvFile').addEventListener('change', function() {
                if (this.files.length > 0) {
                    uploadCSV();
                }
            });
        });
    </script>
</body>
</html>
